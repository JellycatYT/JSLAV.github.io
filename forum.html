<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Reddit-style Multi-section Forum</title>
  <style>
    body { font-family: Arial; background: #f0f0f0; margin: 0; }
    #container { display: flex; max-width: 1100px; margin: 30px auto; background: #fff; border-radius: 10px; min-height: 650px; box-shadow: 0 2px 16px #bbb5; }
    #sidebar { width: 200px; background: #eee; border-radius: 10px 0 0 10px; padding: 24px 12px 12px 12px; }
    #sidebar h3 { margin-top: 0; }
    .channel { margin-bottom: 12px; cursor: pointer; padding: 6px 12px; border-radius: 5px; }
    .channel.selected { background: #d2e6fa; font-weight: bold; }
    #forum { flex: 1; padding: 24px 32px; }
    .post { border-bottom: 1px solid #eee; margin-bottom: 1.2em; padding-bottom: 1.1em; }
    .post:last-child { border-bottom: none; }
    .post-title { font-weight: bold; font-size: 1.1em; }
    .post-time { color: #666; font-size: 0.9em; }
    .post-user { color: #3366bb; font-size: 0.95em; }
    .reply { margin-left: 24px; border-left: 2px solid #eee; padding-left: 12px; margin-top: 8px; background: #fafafa; border-radius: 4px; }
    .actions { margin-top: 6px; }
    .like-btn, .reply-btn, .delete-btn { border: none; background: #eee; color: #333; padding: 2px 7px; margin-right: 6px; border-radius: 4px; cursor: pointer; }
    .like-btn.liked { background: #aeeaae; color: #174317; }
    .delete-btn { background: #faa; color: #a00; }
    .logout-btn { float: right; }
    #loginForm, #signupForm { margin-bottom: 1.2em; }
    #back-link { display: inline-block; margin-bottom: 18px; text-decoration: none; color: #3366bb; }
    #back-link:hover { text-decoration: underline; }
    #post-type { margin-bottom: 5px; }
    .media-thumb { max-width: 400px; max-height: 300px; display: block; margin: 8px 0; border-radius: 8px; }
    .audio-thumb { margin-top: 10px; }
    .file-section { margin-top:8px; font-size:0.96em; }
    .file-section label { font-weight: bold; }
    .file-download { display:inline-block; margin-left: 8px; color: #3366bb; text-decoration: underline; cursor:pointer; }
    .admin-badge { background: #3366bb; color: #fff; font-size:0.85em; border-radius:4px; padding: 2px 6px; margin-left:5px; }
    #fileInput { margin-top: 4px; }
  </style>
</head>
<body>
  <div id="container">
    <div id="sidebar">
      <h3>Channels</h3>
      <div class="channel selected" onclick="selectChannel('General')" id="ch-General">General</div>
      <div class="channel" onclick="selectChannel('Videos')" id="ch-Videos">Videos</div>
      <div class="channel" onclick="selectChannel('Music')" id="ch-Music">Music</div>
      <div class="channel" onclick="selectChannel('MIDI')" id="ch-MIDI">MIDI</div>
      <div class="channel" onclick="selectChannel('Games')" id="ch-Games">Games</div>
    </div>
    <div id="forum">
      <a href="index.html" id="back-link">&larr; Back to front page</a>
      <button class="logout-btn" onclick="logout()" style="display:none;" id="logoutBtn">Log out (<span id="currentUser"></span>)</button>
      <div id="authForms"></div>
      <div id="mainContent" style="display:none;">
        <form id="postForm" autocomplete="off">
          <input type="text" id="title" placeholder="Title" required style="width:100%;margin-bottom:5px;">
          <select id="post-type" required>
            <option value="text">Text</option>
            <option value="image">Image (URL)</option>
            <option value="youtube">YouTube video (URL)</option>
            <option value="audio">Audio/MP3/WAV (URL)</option>
            <option value="midi">MIDI file (URL)</option>
            <option value="game">Game link (itch.io/html/zip/exe URL)</option>
            <option value="link">Other link</option>
            <option value="localfile">Attach file (only for yourself)</option>
          </select>
          <textarea id="content" placeholder="Write your message or paste a link..." required style="width:100%;height:60px;"></textarea>
          <div class="file-section" id="fileSection" style="display:none;">
            <label for="fileInput">Attach file (max 4MB):</label>
            <input type="file" id="fileInput" accept="*/*">
            <span id="fileName"></span>
          </div>
          <button type="submit">Post</button>
        </form>
        <h3 id="channel-title">General</h3>
        <div id="posts"></div>
      </div>
    </div>
  </div>
  <script>
    // --------- Admin config ---------
    // Lisää tähän käyttäjänimet, joilla on admin-oikeudet
    const ADMIN_USERS = ["JSLAV", "MyMod1", "SuperUser"];

    function isAdmin() {
      return ADMIN_USERS.includes(getCurrentUser());
    }

    // --------- Channels ---------
    let currentChannel = 'General';
    function selectChannel(name) {
      currentChannel = name;
      for (const ch of ['General','Videos','Music','MIDI','Games']) {
        document.getElementById('ch-'+ch).className = 'channel' + (ch === name ? ' selected' : '');
      }
      document.getElementById('channel-title').textContent = name;
      renderPosts();
    }

    // --------- User Auth ---------
    function getUsers() {
      return JSON.parse(localStorage.getItem('forumUsers') || '{}');
    }
    function saveUsers(users) {
      localStorage.setItem('forumUsers', JSON.stringify(users));
    }
    function setCurrentUser(username) {
      if (username) localStorage.setItem('forumCurrentUser', username);
      else localStorage.removeItem('forumCurrentUser');
    }
    function getCurrentUser() {
      return localStorage.getItem('forumCurrentUser');
    }

    // --------- Auth Forms ---------
    function renderAuthForms() {
      const authDiv = document.getElementById('authForms');
      if (getCurrentUser()) {
        document.getElementById('mainContent').style.display = '';
        document.getElementById('logoutBtn').style.display = '';
        document.getElementById('currentUser').innerText = getCurrentUser();
        authDiv.innerHTML = '';
      } else {
        document.getElementById('mainContent').style.display = 'none';
        document.getElementById('logoutBtn').style.display = 'none';
        authDiv.innerHTML = `
        <div id="loginForm">
          <h3>Log in</h3>
          <form onsubmit="login(event)">
            <input type="text" id="login-username" placeholder="Username" required>
            <input type="password" id="login-password" placeholder="Password" required>
            <button type="submit">Log in</button>
          </form>
          <div style="margin-top:6px;font-size:0.9em;">No account? <a href="#" onclick="showSignup();return false;">Sign up here</a></div>
          <div id="login-error" style="color:red;"></div>
        </div>
        <div id="signupForm" style="display:none;">
          <h3>Sign up</h3>
          <form onsubmit="signup(event)">
            <input type="text" id="signup-username" placeholder="Username" required>
            <input type="password" id="signup-password" placeholder="Password" required>
            <button type="submit">Sign up</button>
            <button type="button" onclick="showLogin()" style="margin-left:10px;">Cancel</button>
          </form>
          <div id="signup-error" style="color:red;"></div>
        </div>
        `;
      }
    }
    function showSignup() {
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('signupForm').style.display = '';
    }
    function showLogin() {
      document.getElementById('loginForm').style.display = '';
      document.getElementById('signupForm').style.display = 'none';
    }
    function login(e) {
      e.preventDefault();
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;
      const users = getUsers();
      if (users[username] && users[username].password === password) {
        setCurrentUser(username);
        renderAuthForms();
        loadPosts();
      } else {
        document.getElementById('login-error').innerText = "Wrong username or password.";
      }
    }
    function signup(e) {
      e.preventDefault();
      const username = document.getElementById('signup-username').value.trim();
      const password = document.getElementById('signup-password').value;
      if (username.length < 3 || password.length < 3) {
        document.getElementById('signup-error').innerText = "Username and password must be at least 3 characters.";
        return;
      }
      const users = getUsers();
      if (users[username]) {
        document.getElementById('signup-error').innerText = "Username already exists.";
        return;
      }
      users[username] = { password };
      saveUsers(users);
      setCurrentUser(username);
      renderAuthForms();
      loadPosts();
    }
    function logout() {
      setCurrentUser(null);
      renderAuthForms();
      loadPosts();
    }

    // --------- Posts ---------
    function getPosts() {
      return JSON.parse(localStorage.getItem('forumPostsV4') || "[]");
    }
    function savePosts(posts) {
      localStorage.setItem('forumPostsV4', JSON.stringify(posts));
    }
    function getLikes() {
      return JSON.parse(localStorage.getItem('forumLikesV4') || '{}');
    }
    function saveLikes(likes) {
      localStorage.setItem('forumLikesV4', JSON.stringify(likes));
    }
    function renderPosts() {
      const posts = getPosts();
      const likes = getLikes();
      const postsDiv = document.getElementById('posts');
      const user = getCurrentUser();
      const channel = currentChannel;
      postsDiv.innerHTML = "";
      posts.filter(p => p.channel === channel).forEach((p, idx) => {
        const el = document.createElement('div');
        el.className = "post";
        let likeCount = (likes[p.id] && likes[p.id].length) ? likes[p.id].length : 0;
        let liked = user && likes[p.id] && likes[p.id].includes(user);
        el.innerHTML = `
          <div class="post-title">${p.title}${isAdminUser(p.user) ? ' <span class="admin-badge">admin</span>' : ''}</div>
          <div class="post-time">${p.time} <span class="post-user">by ${p.user}</span></div>
          <div>${renderPostContent(p)}</div>
          ${renderLocalFileSection(p)}
          <div class="actions">
            <button class="like-btn${liked ? ' liked' : ''}" onclick="likePost('${p.id}')">
              👍 Like (<span id="like-count-${p.id}">${likeCount}</span>)
            </button>
            <button class="reply-btn" onclick="showReplyForm('${p.id}')">Reply</button>
            ${isAdmin() ? `<button class="delete-btn" onclick="deletePost('${p.id}')">Delete</button>` : ''}
          </div>
          <div id="replies-${p.id}">
            ${renderReplies(p.replies || [], p.id)}
          </div>
          <div id="reply-form-${p.id}" style="display:none;margin-top:8px;">
            <form onsubmit="submitReply(event, '${p.id}')">
              <textarea id="reply-content-${p.id}" placeholder="Write your reply..." required style="width:90%;height:40px;"></textarea>
              <button type="submit">Submit reply</button>
              <button type="button" onclick="hideReplyForm('${p.id}')" style="margin-left:6px;">Cancel</button>
            </form>
          </div>
        `;
        postsDiv.appendChild(el);
      });
    }
    function renderPostContent(p) {
      if (p.type === 'image') {
        return `<img src="${p.content.trim()}" alt="image" class="media-thumb">`;
      }
      if (p.type === 'youtube') {
        let url = p.content.trim();
        let idMatch = url.match(/(?:youtube\.com\/.*v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
        let id = idMatch ? idMatch[1] : null;
        if (id) {
          return `<iframe width="320" height="180" src="https://www.youtube.com/embed/${id}" frameborder="0" allowfullscreen class="media-thumb"></iframe>`;
        }
        return `<a href="${url}" target="_blank">${url}</a>`;
      }
      if (p.type === 'audio') {
        return `<audio controls src="${p.content.trim()}" class="audio-thumb"></audio>
          <div><a href="${p.content.trim()}" target="_blank">[Open audio]</a></div>`;
      }
      if (p.type === 'midi') {
        return `<div><a href="${p.content.trim()}" target="_blank">🎹 Listen/download MIDI</a></div>`;
      }
      if (p.type === 'game') {
        return `<a href="${p.content.trim()}" target="_blank">🎮 Play/download game</a>`;
      }
      if (p.type === 'link') {
        return `<a href="${p.content.trim()}" target="_blank">${p.content.trim()}</a>`;
      }
      if (p.type === 'localfile') {
        return `<i>Attached file (only visible/downloadable for yourself):</i>`;
      }
      return p.content.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>");
    }
    function renderLocalFileSection(p) {
      // Show "download file" only if post.type === localfile and file exists in this user's LocalStorage
      if (p.type === 'localfile') {
        let key = 'userFile_'+p.localFileName;
        let dataUrl = localStorage.getItem(key);
        if (dataUrl) {
          return `<div class="file-section">Your attached file: <b>${p.localFileName}</b>
            <a class="file-download" onclick="downloadLocalFile('${p.localFileName}')">Download</a></div>`;
        } else {
          return `<div class="file-section" style="color:#a00;">File not found in your browser (only the uploader can see/download it)</div>`;
        }
      }
      return "";
    }
    function renderReplies(replies, postId) {
      if (!replies || !replies.length) return "";
      return replies.map((r, idx) => `
        <div class="reply">
          <div class="post-time">${r.time} <span class="post-user">by ${r.user}</span>${isAdminUser(r.user) ? ' <span class="admin-badge">admin</span>' : ''}</div>
          <div>${r.content.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>")}</div>
          ${isAdmin() ? `<button class="delete-btn" style="margin-top:6px;" onclick="deleteReply('${postId}',${idx})">Delete</button>` : ''}
        </div>
      `).join('');
    }
    function likePost(postId) {
      const user = getCurrentUser();
      if (!user) {
        alert("You must be logged in to like posts.");
        return;
      }
      let likes = getLikes();
      likes[postId] = likes[postId] || [];
      if (likes[postId].includes(user)) {
        likes[postId] = likes[postId].filter(u => u !== user);
      } else {
        likes[postId].push(user);
      }
      saveLikes(likes);
      renderPosts();
    }
    function showReplyForm(postId) {
      if (!getCurrentUser()) {
        alert("You must be logged in to reply.");
        return;
      }
      document.getElementById('reply-form-' + postId).style.display = '';
      document.getElementById('reply-content-' + postId).focus();
    }
    function hideReplyForm(postId) {
      document.getElementById('reply-form-' + postId).style.display = 'none';
    }
    function submitReply(e, postId) {
      e.preventDefault();
      const content = document.getElementById('reply-content-' + postId).value.trim();
      if (!content) return;
      const user = getCurrentUser();
      const posts = getPosts();
      const postIdx = posts.findIndex(p => p.id === postId);
      if (postIdx === -1) return;
      posts[postIdx].replies = posts[postIdx].replies || [];
      posts[postIdx].replies.push({
        content: content,
        user: user,
        time: new Date().toLocaleString()
      });
      savePosts(posts);
      hideReplyForm(postId);
      renderPosts();
    }
    function isAdminUser(username) {
      return ADMIN_USERS.includes(username);
    }
    // --------- Poistotoiminto ---------
    function deletePost(postId) {
      if (!isAdmin()) { alert("Only admins can delete."); return; }
      if (!confirm("Delete this post?")) return;
      let posts = getPosts();
      posts = posts.filter(p => p.id !== postId);
      savePosts(posts);
      renderPosts();
    }
    function deleteReply(postId, replyIdx) {
      if (!isAdmin()) { alert("Only admins can delete."); return; }
      if (!confirm("Delete this reply?")) return;
      let posts = getPosts();
      const post = posts.find(p => p.id === postId);
      if (post && post.replies && post.replies[replyIdx]) {
        post.replies.splice(replyIdx,1);
        savePosts(posts);
        renderPosts();
      }
    }
    // --------- Local file attach & download ---------
    let attachedFile = null;
    let attachedFileName = "";
    document.getElementById('post-type').onchange = function() {
      if (this.value === 'localfile') {
        document.getElementById('fileSection').style.display = '';
      } else {
        document.getElementById('fileSection').style.display = 'none';
        attachedFile = null; attachedFileName = ""; document.getElementById('fileName').innerText = "";
        document.getElementById('fileInput').value = "";
      }
    };
    document.getElementById('fileInput').onchange = function(e) {
      const file = e.target.files[0];
      if (!file) return;
      if (file.size > 4*1024*1024) { alert("File too large (max 4MB)"); this.value = ""; return; }
      attachedFileName = file.name;
      document.getElementById('fileName').innerText = file.name;
      const reader = new FileReader();
      reader.onload = function(evt) {
        attachedFile = evt.target.result;
      }
      reader.readAsDataURL(file);
    };
    function downloadLocalFile(fileName) {
      let key = 'userFile_'+fileName;
      let dataUrl = localStorage.getItem(key);
      if (!dataUrl) { alert("File not found in your browser."); return; }
      let a = document.createElement('a');
      a.href = dataUrl;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>document.body.removeChild(a),100);
    }

    // --------- Add new post ---------
    document.getElementById('postForm').onsubmit = function(e) {
      e.preventDefault();
      const user = getCurrentUser();
      if (!user) {
        alert("You must be logged in to post.");
        return;
      }
      const title = document.getElementById('title').value.trim();
      const content = document.getElementById('content').value.trim();
      const type = document.getElementById('post-type').value;
      if (!title || (!content && type !== 'localfile')) return;
      const posts = getPosts();
      let postObj = {
        id: 'p' + Date.now() + Math.floor(Math.random()*99999),
        title,
        content,
        user,
        type,
        channel: currentChannel,
        time: new Date().toLocaleString(),
        replies: []
      };
      if (type === 'localfile') {
        if (!attachedFile || !attachedFileName) { alert("Attach a file first!"); return; }
        // File saved only for this user
        localStorage.setItem('userFile_'+attachedFileName, attachedFile);
        postObj.localFileName = attachedFileName;
      }
      posts.unshift(postObj);
      savePosts(posts);
      document.getElementById('title').value = "";
      document.getElementById('content').value = "";
      if (type === 'localfile') {
        attachedFile = null; attachedFileName = "";
        document.getElementById('fileName').innerText = "";
        document.getElementById('fileInput').value = "";
        document.getElementById('fileSection').style.display = 'none';
        document.getElementById('post-type').value = 'text';
      }
      renderPosts();
    }

    // --------- Initial load ---------
    function loadPosts() {
      if (getCurrentUser()) {
        document.getElementById('mainContent').style.display = '';
      } else {
        document.getElementById('mainContent').style.display = 'none';
      }
      renderPosts();
    }

    renderAuthForms();
    loadPosts();
  </script>
</body>
</html>
